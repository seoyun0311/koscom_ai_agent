<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-WON Reserve Verification System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-orange: #ff6b35;
        --secondary-orange: #ff8c42;
        --dark-bg: #0a0a0a;
        --card-bg: #1a1a1a;
        --border-color: #2a2a2a;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --success: #00e676;
        --warning: #ffb74d;
        --danger: #ff5252;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--dark-bg);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 0;
        margin: 0;
        min-height: 100vh;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 40px 30px;
      }

      /* Header */
      .header {
        margin-bottom: 50px;
        padding-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(
          135deg,
          var(--primary-orange),
          var(--secondary-orange)
        );
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
      }

      .logo-text h1 {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin-bottom: 2px;
      }

      .logo-text p {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 400;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-dot.online {
        background: var(--success);
        box-shadow: 0 0 10px var(--success);
      }

      .status-dot.offline {
        background: var(--danger);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .status-text {
        font-size: 14px;
        font-weight: 500;
      }

      /* Control Panel */
      .control-panel {
        display: flex;
        gap: 12px;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 14px 28px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: 'Inter', sans-serif;
        letter-spacing: 0.3px;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-orange),
          var(--secondary-orange)
        );
        color: white;
        box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(255, 107, 53, 0.4);
      }

      .btn-secondary {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: #252525;
        border-color: var(--primary-orange);
      }

      /* Loading & Error */
      .loading {
        display: none;
        text-align: center;
        padding: 30px;
        background: var(--card-bg);
        border-radius: 12px;
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
      }

      .loading.active {
        display: block;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        display: none;
        padding: 20px;
        background: rgba(255, 82, 82, 0.1);
        border: 1px solid var(--danger);
        border-radius: 12px;
        color: var(--danger);
        margin-bottom: 30px;
      }

      .error-message.active {
        display: block;
      }

      /* Grid Layout */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      /* Card */
      .card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 30px;
        transition: all 0.3s ease;
      }

      .card:hover {
        border-color: var(--primary-orange);
        box-shadow: 0 8px 30px rgba(255, 107, 53, 0.15);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .card-icon {
        font-size: 24px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      /* Metrics */
      .metric {
        margin-bottom: 20px;
      }

      .metric-label {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .metric-value {
        font-size: 32px;
        font-weight: 700;
        letter-spacing: -1px;
        color: var(--text-primary);
      }

      .metric-value.ok {
        color: var(--success);
      }
      .metric-value.warning {
        color: var(--warning);
      }
      .metric-value.danger {
        color: var(--danger);
      }

      .metric-sublabel {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 5px;
      }

      /* Custodian List */
      .custodian-list {
        list-style: none;
      }

      .custodian-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        margin-bottom: 10px;
        background: rgba(255, 107, 53, 0.05);
        border: 1px solid rgba(255, 107, 53, 0.1);
        border-radius: 10px;
        transition: all 0.2s ease;
      }

      .custodian-item:hover {
        background: rgba(255, 107, 53, 0.1);
        border-color: rgba(255, 107, 53, 0.3);
      }

      .custodian-name {
        font-size: 14px;
        font-weight: 500;
      }

      .custodian-amount {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-orange);
      }

      /* Timestamp */
      .timestamp {
        font-size: 11px;
        color: var(--text-secondary);
        text-align: right;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
      }

      /* Coverage Bar */
      .coverage-bar {
        width: 100%;
        height: 12px;
        background: var(--border-color);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 15px;
      }

      .coverage-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary-orange),
          var(--secondary-orange)
        );
        transition: width 0.5s ease;
        border-radius: 6px;
      }

      /* Risk Indicators */
      .risk-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
      }

      .risk-indicator {
        padding: 15px;
        background: rgba(255, 107, 53, 0.05);
        border: 1px solid rgba(255, 107, 53, 0.1);
        border-radius: 10px;
        text-align: center;
      }

      .risk-indicator-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .risk-indicator-value {
        font-size: 20px;
        font-weight: 700;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .header-top {
          flex-direction: column;
          align-items: flex-start;
          gap: 20px;
        }

        .control-panel {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-top">
          <div class="logo">
            <div class="logo-icon">‚Ç©</div>
            <div class="logo-text">
              <h1>K-WON Reserve System</h1>
              <p>Real-time Collateral Verification Dashboard</p>
            </div>
          </div>
          <div class="status-badge">
            <div class="status-dot online" id="statusDot"></div>
            <span class="status-text" id="statusText">System Online</span>
          </div>
        </div>
      </div>

      <!-- Control Panel -->
      <div class="control-panel">
        <button class="btn btn-primary" onclick="fullVerification()">
          ‚ö° Full Verification
        </button>
        <button class="btn btn-secondary" onclick="getOnchainState()">
          üîó On-Chain
        </button>
        <button class="btn btn-secondary" onclick="getOffchainReserves()">
          üè¶ Off-Chain
        </button>
        <button class="btn btn-secondary" onclick="getCoverage()">
          üìä Coverage
        </button>
        <button class="btn btn-secondary" onclick="getRiskReport()">
          ‚ö†Ô∏è Risk Report
        </button>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Loading verification data...</div>
      </div>

      <!-- Error Message -->
      <div class="error-message" id="errorMessage"></div>

      <!-- Data Grid -->
      <div class="grid">
        <!-- On-Chain State -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üîó</span>
            <h2 class="card-title">On-Chain State</h2>
          </div>
          <div class="metric">
            <div class="metric-label">Total Supply</div>
            <div class="metric-value" id="totalSupply">-</div>
            <div class="metric-sublabel">K-WON tokens issued</div>
          </div>
          <div class="metric">
            <div class="metric-label">Net Circulation</div>
            <div class="metric-value" id="netCirculation">-</div>
            <div class="metric-sublabel" id="burnedAmount">Burned: -</div>
          </div>
          <div class="timestamp" id="onchainTimestamp"></div>
        </div>

        <!-- Off-Chain Reserves -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üè¶</span>
            <h2 class="card-title">Off-Chain Reserves</h2>
          </div>
          <div class="metric">
            <div class="metric-label">Total Reserves</div>
            <div class="metric-value" id="totalReserves">-</div>
            <div class="metric-sublabel" id="custodianCount">
              - custodian banks
            </div>
          </div>
          <ul class="custodian-list" id="custodianList"></ul>
          <div class="timestamp" id="offchainTimestamp"></div>
        </div>

        <!-- Collateral Coverage -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üìä</span>
            <h2 class="card-title">Collateral Coverage</h2>
          </div>
          <div class="metric">
            <div class="metric-label">Coverage Ratio</div>
            <div class="metric-value" id="coverageRatio">-</div>
            <div class="coverage-bar">
              <div
                class="coverage-fill"
                id="coverageFill"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">Excess Collateral</div>
            <div class="metric-value" id="excessCollateral">-</div>
            <div class="metric-sublabel" id="coverageStatus">Status: -</div>
          </div>
          <div class="timestamp" id="coverageTimestamp"></div>
        </div>

        <!-- Risk Report -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">‚ö†Ô∏è</span>
            <h2 class="card-title">Risk Assessment</h2>
          </div>
          <div class="risk-grid">
            <div class="risk-indicator">
              <div class="risk-indicator-label">Overall Status</div>
              <div class="risk-indicator-value ok" id="overallRisk">-</div>
            </div>
            <div class="risk-indicator">
              <div class="risk-indicator-label">Concentration Risk</div>
              <div class="risk-indicator-value ok" id="concentrationRisk">
                -
              </div>
            </div>
          </div>
          <div class="metric" style="margin-top: 20px">
            <div class="metric-label">Max Custodian Concentration</div>
            <div
              class="metric-value"
              id="maxConcentration"
              style="font-size: 24px"
            >
              -
            </div>
          </div>
          <div class="timestamp" id="riskTimestamp"></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:5000/api';

      // Page load - check backend health
      window.addEventListener('load', checkBackendHealth);

      async function checkBackendHealth() {
        try {
          const response = await fetch(`${API_BASE}/health`);
          const data = await response.json();
          updateConnectionStatus(true);
        } catch (error) {
          updateConnectionStatus(false);
          showError(
            'Backend server is not running. Please start flask_backend_simple.py'
          );
        }
      }

      function updateConnectionStatus(isOnline) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        if (isOnline) {
          statusDot.className = 'status-dot online';
          statusText.textContent = 'System Online';
        } else {
          statusDot.className = 'status-dot offline';
          statusText.textContent = 'System Offline';
        }
      }

      function showLoading() {
        document.getElementById('loading').classList.add('active');
        document.getElementById('errorMessage').classList.remove('active');
      }

      function hideLoading() {
        document.getElementById('loading').classList.remove('active');
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = '‚ùå ' + message;
        errorDiv.classList.add('active');
      }

      function formatNumber(num) {
        return new Intl.NumberFormat('ko-KR').format(num);
      }

      function formatKRW(num) {
        return '‚Ç©' + formatNumber(num);
      }

      // Full Verification
      async function fullVerification() {
        showLoading();
        try {
          const response = await fetch(`${API_BASE}/full-verification`);
          const result = await response.json();

          if (result.success) {
            updateOnchainUI(result.data.onchain);
            updateOffchainUI(result.data.offchain);
            updateCoverageUI(result.data.coverage);
            updateRiskUI(result.data.risk);
          } else {
            showError(result.error);
          }
        } catch (error) {
          showError(`API Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      }

      // On-Chain State
      async function getOnchainState() {
        showLoading();
        try {
          const response = await fetch(`${API_BASE}/onchain-state`);
          const result = await response.json();
          if (result.success) {
            updateOnchainUI(result.data);
          }
        } catch (error) {
          showError(`API Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      }

      function updateOnchainUI(data) {
        document.getElementById('totalSupply').textContent = formatKRW(
          data.total_supply
        );
        document.getElementById('netCirculation').textContent = formatKRW(
          data.net_circulation
        );
        document.getElementById(
          'burnedAmount'
        ).textContent = `Burned: ${formatKRW(data.burned)}`;
        document.getElementById(
          'onchainTimestamp'
        ).textContent = `Updated: ${new Date(data.timestamp).toLocaleString(
          'ko-KR'
        )}`;
      }

      // Off-Chain Reserves
      async function getOffchainReserves() {
        showLoading();
        try {
          const response = await fetch(`${API_BASE}/offchain-reserves`);
          const result = await response.json();
          if (result.success) {
            updateOffchainUI(result.data);
          }
        } catch (error) {
          showError(`API Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      }

      function updateOffchainUI(data) {
        document.getElementById('totalReserves').textContent = formatKRW(
          data.total_reserves
        );
        document.getElementById(
          'custodianCount'
        ).textContent = `${data.custodians.length} custodian banks`;

        const list = document.getElementById('custodianList');
        list.innerHTML = data.custodians
          .map(
            (c) => `
                <li class="custodian-item">
                    <span class="custodian-name">${c.name}</span>
                    <span class="custodian-amount">${formatKRW(c.amount)}</span>
                </li>
            `
          )
          .join('');

        document.getElementById(
          'offchainTimestamp'
        ).textContent = `Updated: ${new Date(data.timestamp).toLocaleString(
          'ko-KR'
        )}`;
      }

      // Coverage
      async function getCoverage() {
        showLoading();
        try {
          const response = await fetch(`${API_BASE}/collateral-coverage`);
          const result = await response.json();
          if (result.success) {
            updateCoverageUI(result.data);
          }
        } catch (error) {
          showError(`API Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      }

      function updateCoverageUI(data) {
        const ratioElement = document.getElementById('coverageRatio');
        ratioElement.textContent = `${data.coverage_ratio}%`;
        ratioElement.className =
          'metric-value ' +
          (data.coverage_ratio >= 105
            ? 'ok'
            : data.coverage_ratio >= 100
            ? 'warning'
            : 'danger');

        document.getElementById('coverageFill').style.width =
          Math.min(data.coverage_ratio, 150) + '%';
        document.getElementById('excessCollateral').textContent = formatKRW(
          data.excess_collateral
        );
        document.getElementById(
          'coverageStatus'
        ).textContent = `Status: ${data.status}`;
        document.getElementById(
          'coverageTimestamp'
        ).textContent = `Updated: ${new Date(data.timestamp).toLocaleString(
          'ko-KR'
        )}`;
      }

      // Risk Report
      async function getRiskReport() {
        showLoading();
        try {
          const response = await fetch(`${API_BASE}/risk-report`);
          const result = await response.json();
          if (result.success) {
            updateRiskUI(result.data);
          }
        } catch (error) {
          showError(`API Error: ${error.message}`);
        } finally {
          hideLoading();
        }
      }

      function updateRiskUI(data) {
        const overallElement = document.getElementById('overallRisk');
        overallElement.textContent = data.overall_status;
        overallElement.className =
          'risk-indicator-value ' +
          (data.overall_status === 'HEALTHY'
            ? 'ok'
            : data.overall_status === 'WARNING'
            ? 'warning'
            : 'danger');

        const concentrationElement =
          document.getElementById('concentrationRisk');
        concentrationElement.textContent = data.concentration_risk;
        concentrationElement.className =
          'risk-indicator-value ' +
          (data.concentration_risk === 'LOW'
            ? 'ok'
            : data.concentration_risk === 'MODERATE'
            ? 'warning'
            : 'danger');

        document.getElementById(
          'maxConcentration'
        ).textContent = `${data.max_custodian_concentration}%`;
        document.getElementById(
          'riskTimestamp'
        ).textContent = `Updated: ${new Date(data.timestamp).toLocaleString(
          'ko-KR'
        )}`;
      }
    </script>
  </body>
</html>
