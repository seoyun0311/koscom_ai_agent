<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-WON Stablecoin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- ÎßàÌÅ¨Îã§Ïö¥ Î†åÎçîÎßÅ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Chart.js for Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-orange: #ff6b35;
        --light-orange: #ff8c42;
        --dark-bg: #0a0a0a;
        --card-bg: #161616;
        --card-hover: #1f1f1f;
        --border-color: #303030;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --text-muted: #707070;
        --success: #00e676;
        --danger: #ff4757;
        --warning: #ffa502;

        /* ÌÅ¥Î°úÎìú Ïä§ÌÉÄÏùº Ï±ÑÌåÖ Ïª¨Îü¨ */
        --chat-bg: #f5f5f0;
        --chat-user-bg: #4a4a4a;
        --chat-assistant-bg: #ffffff;
        --chat-text: #2c2c2c;
        --chat-text-secondary: #666666;
        --chat-border: #e0e0dc;
        --chat-input-bg: #ffffff;
        --chat-header-bg: #ffffff;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--dark-bg);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 0;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }

      /* Resizer Ïä§ÌÉÄÏùº */
      .resizer {
        width: 5px;
        background: transparent;
        cursor: col-resize;
        position: relative;
        flex-shrink: 0;
        transition: background 0.2s ease;
      }

      .resizer:hover {
        background: var(--primary-orange);
      }

      .resizer::before {
        content: "";
        position: absolute;
        top: 0;
        left: -2px;
        right: -2px;
        bottom: 0;
        cursor: col-resize;
      }

      .resizer.dragging {
        background: var(--primary-orange);
      }

      /* Main Layout */
      .main-container {
        display: flex;
        height: 100vh;
        width: 100%;
      }

      /* Left Panel - Dashboard */
      .dashboard-panel {
        flex: 1;
        overflow-y: auto;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
      }

      /* Right Panel - Claude Chat */
      .chat-panel {
        width: 420px;
        display: flex;
        flex-direction: column;
        background: var(--chat-bg);
        border-left: 1px solid var(--chat-border);
      }

      /* Dashboard Content */
      .dashboard-content {
        padding: 20px;
        max-width: 1800px;
        margin: 0 auto;
        width: 100%;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Header */
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: var(--primary-orange);
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 700;
      }

      .logo-text h1 {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.3px;
        color: var(--text-primary);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 2px;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--success);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .status-text {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Main Content Grid - 2x2 Layout */
      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 12px;
        flex: 1;
        min-height: 0;
        margin-bottom: 12px;
      }

      /* üî• Off-Chain Reserves - 2Ìñâ Ï†ÑÏ≤¥ Ï∞®ÏßÄ, Îπà Í≥µÍ∞Ñ ÏóÜÏù¥ ÌôïÏû• */
      .content-card.offchain-card {
        grid-row: 1 / 3;
        grid-column: 2;
        height: 100%;
      }

      /* Card Styles */
      .content-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease;
        min-height: 0;
        overflow: hidden;
      }

      .content-card:hover {
        border-color: var(--primary-orange);
        background: var(--card-hover);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border-color);
        flex-shrink: 0;
      }

      .card-title-section {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-icon {
        font-size: 18px;
      }

      .card-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 1.2px;
      }

      .card-value {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .value-ok {
        color: var(--success);
      }
      .value-warning {
        color: var(--warning);
      }
      .value-danger {
        color: var(--danger);
      }

      /* Data Rows */
      .data-row {
        padding: 14px 16px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 0;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .data-row:hover {
        background: rgba(255, 107, 53, 0.08);
        border-color: rgba(255, 107, 53, 0.4);
      }

      .data-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 6px;
        font-weight: 700;
      }

      .data-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        font-family: "Inter", monospace;
        line-height: 1.2;
      }

      .data-subtitle {
        font-size: 9px;
        color: var(--text-muted);
        margin-top: 4px;
        line-height: 1.4;
      }

      /* Coverage Bar */
      .coverage-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 0;
        overflow: hidden;
        margin-top: 10px;
        border: 1px solid var(--border-color);
      }

      .coverage-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary-orange),
          var(--light-orange)
        );
        border-radius: 0;
        transition: width 0.5s ease;
        box-shadow: 0 0 12px rgba(255, 107, 53, 0.5);
      }

      /* Custodian List - Ïä§ÌÅ¨Î°§ Í∞ÄÎä• */
      .custodian-list {
        list-style: none;
        margin-top: 10px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
      }

      .custodian-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        margin-bottom: 10px;
        background: rgba(255, 107, 53, 0.05);
        border: 1px solid rgba(255, 107, 53, 0.2);
        border-radius: 0;
        transition: all 0.2s ease;
      }

      .custodian-item:hover {
        background: rgba(255, 107, 53, 0.12);
        border-color: var(--primary-orange);
        transform: translateX(4px);
      }

      .custodian-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        letter-spacing: 0.3px;
      }

      .custodian-amount {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary-orange);
        font-family: "Inter", monospace;
      }

      /* üî• Off-Chain Reserves ÎÇ¥Î∂Ä Î≤ÑÌäº */
      .role-analysis-button {
        width: 100%;
        padding: 14px;
        margin-top: 12px;
        background: var(--primary-orange);
        border: none;
        color: white;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .role-analysis-button:hover {
        background: var(--light-orange);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
      }

      /* Action Buttons */
      .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        flex-shrink: 0;
      }

      .action-card-compact {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
        padding: 16px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        position: relative;
      }

      .action-card-compact:hover {
        background: rgba(255, 107, 53, 0.08);
        border-color: var(--primary-orange);
      }

      .action-icon-compact {
        font-size: 28px;
        flex-shrink: 0;
      }

      .action-content {
        flex: 1;
      }

      .action-title-compact {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
      }

      .action-description-compact {
        font-size: 10px;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .action-button-small {
        padding: 8px 16px;
        background: var(--primary-orange);
        color: white;
        border: none;
        border-radius: 0;
        font-size: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        z-index: 10;
        position: relative;
      }

      .action-button-small:hover {
        background: var(--light-orange);
        transform: scale(1.05);
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: var(--card-bg);
        border: 2px solid var(--primary-orange);
        width: 90%;
        max-width: 1000px;
        max-height: 85vh;
        overflow-y: auto;
        border-radius: 0;
        box-shadow: 0 20px 60px rgba(255, 107, 53, 0.3);
      }

      .modal-header {
        padding: 24px 32px;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 107, 53, 0.05);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 1.2px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .modal-close {
        width: 36px;
        height: 36px;
        background: transparent;
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .modal-close:hover {
        background: var(--danger);
        border-color: var(--danger);
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 32px;
      }

      /* Role-Based Allocation in Modal */
      .role-section-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 12px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-primary);
      }

      .role-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-color);
        font-size: 12px;
        margin-bottom: 18px;
      }

      .role-table thead {
        background: rgba(255, 255, 255, 0.04);
      }

      .role-table th {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
        color: var(--text-secondary);
        font-weight: 700;
        letter-spacing: 0.8px;
        text-transform: uppercase;
      }

      .role-table td {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
      }

      .role-table tr:hover {
        background: rgba(255, 107, 53, 0.08);
        transition: 0.15s ease;
      }

      .rebalance-box {
        background: rgba(255, 107, 53, 0.05);
        border: 1px solid rgba(255, 107, 53, 0.25);
        padding: 16px;
        margin-top: 16px;
        margin-bottom: 16px;
      }

      .rebalance-item {
        padding: 12px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 107, 53, 0.25);
        background: rgba(255, 107, 53, 0.08);
        font-size: 12px;
      }

      .rebalance-item strong {
        color: var(--primary-orange);
        font-weight: 700;
      }

      #rolePieContainer {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
        text-align: center;
      }

      #rolePieChart {
        max-width: 400px;
        margin: 0 auto;
      }

      /* Proof Pack Modal Styles */
      .proof-pack-list {
        list-style: none;
      }

      .proof-pack-item {
        padding: 20px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 0;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .proof-pack-item:hover {
        background: rgba(255, 107, 53, 0.08);
        border-color: var(--primary-orange);
        transform: translateX(4px);
      }

      .proof-pack-info {
        flex: 1;
      }

      .proof-pack-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        font-family: "Inter", monospace;
      }

      .proof-pack-meta {
        font-size: 11px;
        color: var(--text-secondary);
      }

      .proof-pack-download {
        padding: 10px 20px;
        background: var(--primary-orange);
        color: white;
        border: none;
        border-radius: 0;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        text-decoration: none;
        display: inline-block;
      }

      .proof-pack-download:hover {
        background: var(--light-orange);
        transform: scale(1.05);
      }

      .empty-state {
        text-align: center;
        padding: 60px 40px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
      }

      .empty-state-description {
        font-size: 13px;
        line-height: 1.6;
        max-width: 400px;
        margin: 0 auto;
      }

      /* Chat Panel Styles - ÌÅ¥Î°úÎìú Ïä§ÌÉÄÏùº */
      .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--chat-border);
        background: var(--chat-header-bg);
        flex-shrink: 0;
      }

      .chat-header h2 {
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--chat-text);
        text-transform: none;
        letter-spacing: 0;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: var(--chat-bg);
      }

      .message {
        max-width: 90%;
        padding: 14px 18px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.65;
        word-break: break-word;
        overflow-wrap: anywhere;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }

      .message.user {
        align-self: flex-end;
        background: var(--chat-user-bg);
        color: #ffffff;
        border-radius: 18px 18px 4px 18px;
        font-weight: 400;
      }

      .message.assistant {
        align-self: flex-start;
        background: var(--chat-assistant-bg);
        border: 1px solid var(--chat-border);
        color: #2c2c2c;
        border-radius: 18px 18px 18px 4px;
        font-weight: 400;
      }

      /* Markdown Styling for Assistant Messages */
      .message.assistant h1,
      .message.assistant h2,
      .message.assistant h3 {
        color: #1a1a1a;
        font-weight: 600;
        margin: 18px 0 10px 0;
        line-height: 1.4;
      }

      .message.assistant h1 {
        font-size: 20px;
      }
      .message.assistant h2 {
        font-size: 17px;
        color: #ff7f50;
      }
      .message.assistant h3 {
        font-size: 15px;
      }

      .message.assistant strong {
        color: #ff7f50;
        font-weight: 600;
      }

      .message.assistant code {
        background: #f7f7f7;
        padding: 3px 8px;
        border-radius: 5px;
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 13px;
        color: #b35926;
        border: 1px solid #e9e9e9;
      }

      .message.assistant pre {
        background: #f9f9f9;
        padding: 14px 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 12px 0;
        border: 1px solid #e5e5e5;
      }

      .message.assistant pre code {
        background: none;
        padding: 0;
        color: #2c2c2c;
        border: none;
        font-size: 13px;
        line-height: 1.6;
      }

      .message.assistant ul,
      .message.assistant ol {
        margin: 12px 0;
        padding-left: 28px;
        color: #2c2c2c;
      }

      .message.assistant li {
        margin: 8px 0;
        line-height: 1.65;
        color: #2c2c2c;
      }

      .message.assistant li::marker {
        color: #ff7f50;
      }

      .message.assistant p {
        margin: 10px 0;
        line-height: 1.65;
        color: #2c2c2c;
      }

      .message.assistant table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
        font-size: 13px;
        color: #2c2c2c;
      }

      .message.assistant table th {
        background: #f7f7f7;
        font-weight: 600;
        color: #1a1a1a;
        border: 1px solid #e0e0dc;
        padding: 10px 12px;
        text-align: left;
      }

      .message.assistant table td {
        border: 1px solid #e0e0dc;
        padding: 10px 12px;
        text-align: left;
        color: #2c2c2c;
      }

      .chat-input-area {
        padding: 16px 24px 24px 24px;
        border-top: 1px solid var(--chat-border);
        background: var(--chat-header-bg);
        flex-shrink: 0;
      }

      .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .quick-action-btn {
        padding: 8px 14px;
        background: var(--chat-assistant-bg);
        border: 1px solid var(--chat-border);
        border-radius: 20px;
        color: var(--chat-text);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .quick-action-btn:hover {
        border-color: var(--primary-orange);
        color: var(--primary-orange);
        background: #fff8f5;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        background: var(--chat-input-bg);
        border: 1.5px solid var(--chat-border);
        border-radius: 24px;
        color: var(--chat-text);
        font-size: 14px;
        font-family: "Inter", sans-serif;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        transition: all 0.2s ease;
        line-height: 1.5;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--primary-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .chat-input::placeholder {
        color: #999999;
      }

      .chat-send-btn {
        padding: 12px 24px;
        background: var(--primary-orange);
        border: none;
        border-radius: 24px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
        height: 48px;
      }

      .chat-send-btn:hover {
        background: var(--light-orange);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
      }

      .chat-send-btn:disabled {
        background: #d0d0d0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Loading Animation */
      .loading-dots {
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
      }

      .loading-dots span {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: #ff6b35;
        margin: 0 2px;
        opacity: 0.2;
        animation: dotBlink 1s infinite;
      }

      .loading-dots span:nth-child(1) {
        animation-delay: 0s;
      }
      .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotBlink {
        0%,
        20% {
          opacity: 0.2;
          transform: translateY(0);
        }
        50% {
          opacity: 1;
          transform: translateY(-2px);
        }
        100% {
          opacity: 0.2;
          transform: translateY(0);
        }
      }

      /* Timestamp */
      .timestamp {
        font-size: 8px;
        color: var(--text-muted);
        margin-top: auto;
        padding-top: 12px;
        text-align: right;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        flex-shrink: 0;
      }

      /* Loading Indicator */
      .loading-indicator {
        display: none;
        padding: 12px;
        background: rgba(255, 107, 53, 0.05);
        border: 1px solid var(--primary-orange);
        border-radius: 0;
        margin-bottom: 12px;
        text-align: center;
        flex-shrink: 0;
      }

      .loading-indicator.active {
        display: block;
      }

      .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Scrollbar */
      .dashboard-panel::-webkit-scrollbar,
      .chat-messages::-webkit-scrollbar,
      .custodian-list::-webkit-scrollbar,
      .modal-content::-webkit-scrollbar {
        width: 6px;
      }

      .dashboard-panel::-webkit-scrollbar-track,
      .chat-messages::-webkit-scrollbar-track,
      .custodian-list::-webkit-scrollbar-track,
      .modal-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .dashboard-panel::-webkit-scrollbar-thumb,
      .custodian-list::-webkit-scrollbar-thumb,
      .modal-content::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 0;
      }

      .dashboard-panel::-webkit-scrollbar-thumb:hover,
      .custodian-list::-webkit-scrollbar-thumb:hover,
      .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--primary-orange);
      }

      .chat-messages::-webkit-scrollbar {
        width: 8px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: #d5d5d5;
        border-radius: 10px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #b8b8b8;
      }

      /* Collateral Ratio Card */
      .collateral-ratio-content {
        padding: 16px 18px;
        background: rgba(255, 107, 53, 0.08);
        border: 1px solid rgba(255, 107, 53, 0.3);
        margin-bottom: 10px;
        flex-shrink: 0;
      }

      .offchain-reserves-header {
        padding: 18px 16px;
        background: rgba(255, 107, 53, 0.08);
        border: 1px solid rgba(255, 107, 53, 0.3);
        margin-bottom: 12px;
        flex-shrink: 0;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .chat-panel {
          width: 360px;
        }

        .content-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
        }

        .content-card.offchain-card {
          grid-row: auto;
          grid-column: auto;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .chat-panel {
          width: 100%;
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Dashboard Panel -->
      <div class="dashboard-panel" id="dashboardPanel">
        <div class="dashboard-content">
          <!-- Header -->
          <div class="dashboard-header">
            <div class="logo-section">
              <div class="logo-icon">‚Ç©</div>
              <div class="logo-text">
                <h1>K-WON STABLECOIN DASHBOARD</h1>
              </div>
            </div>
            <div class="status-indicator">
              <div class="status-dot" id="statusDot"></div>
              <span class="status-text" id="statusText">Online</span>
            </div>
          </div>

          <!-- Loading -->
          <div class="loading-indicator" id="loading">
            <span class="loading-spinner"></span>
            <span
              style="
                font-size: 10px;
                color: var(--text-secondary);
                text-transform: uppercase;
              "
              >Loading Data...</span
            >
          </div>

          <!-- Main Content Grid - 2x2 Layout -->
          <div class="content-grid">
            <!-- Top Left: OnChain Supply -->
            <div class="content-card">
              <div class="card-header">
                <div class="card-title-section">
                  <span class="card-icon">üîó</span>
                  <span class="card-title">On-Chain Supply</span>
                </div>
              </div>

              <div class="data-row">
                <div class="data-label">Total Supply</div>
                <div class="data-value" id="totalSupplyMain">-</div>
                <div class="data-subtitle">Blockchain Tokens</div>
              </div>

              <div class="data-row">
                <div class="data-label">Net Circulation</div>
                <div class="data-value" id="netCirculationMain">-</div>
                <div class="data-subtitle">Active Tokens</div>
              </div>

              <div class="data-row">
                <div class="data-label">Burned</div>
                <div class="data-value" id="burnedMain">-</div>
                <div class="data-subtitle">Destroyed Tokens</div>
              </div>

              <div class="timestamp" id="onchainTimestamp">-</div>
            </div>

            <!-- Right: OffChain Reserves (Spans 2 rows, Îπà Í≥µÍ∞Ñ ÏóÜÏù¥ ÌôïÏû•) -->
            <div class="content-card offchain-card">
              <div class="card-header">
                <div class="card-title-section">
                  <span class="card-icon">üè¶</span>
                  <span class="card-title">Off-Chain Reserves</span>
                </div>
              </div>

              <div class="offchain-reserves-header">
                <div class="data-label" style="font-size: 10px">
                  Total Reserves
                </div>
                <div
                  class="card-value"
                  id="totalReservesMain"
                  style="font-size: 32px; margin: 6px 0"
                >
                  -
                </div>
                <div class="data-subtitle" style="font-size: 10px">
                  5 Financial Institutions
                </div>
              </div>

              <!-- Custodian List -->
              <ul class="custodian-list" id="custodianList">
                <!-- Populated dynamically -->
              </ul>

              <!-- üî• Ïó≠Ìï† Í∏∞Î∞ò Î∂ÑÏÑù Î≤ÑÌäº (Off-Chain Reserves Î∞ïÏä§ Ïïà) -->
              <button
                class="role-analysis-button"
                onclick="openRoleAllocationModal()"
              >
                <span>üßÆ</span>
                <span>Ïó≠Ìï† Í∏∞Î∞ò ÎπÑÏ§ë Î∂ÑÏÑù Ïã§Ìñâ</span>
              </button>

              <div class="timestamp" id="offchainTimestamp">-</div>
            </div>

            <!-- Bottom Left: Collateral Ratio -->
            <div class="content-card">
              <div class="card-header">
                <div class="card-title-section">
                  <span class="card-icon">üìä</span>
                  <span class="card-title">Collateral Ratio</span>
                </div>
              </div>

              <div class="collateral-ratio-content">
                <div
                  class="data-label"
                  style="margin-bottom: 8px; font-size: 10px"
                >
                  Coverage Ratio
                </div>
                <div
                  style="
                    display: flex;
                    align-items: baseline;
                    gap: 6px;
                    margin-bottom: 12px;
                  "
                >
                  <span
                    class="card-value"
                    id="coverageRatioMain"
                    style="font-size: 38px"
                    >-</span
                  >
                  <span
                    style="
                      font-size: 24px;
                      color: var(--text-secondary);
                      font-weight: 700;
                    "
                    >%</span
                  >
                </div>
                <div class="coverage-bar" style="margin-bottom: 8px">
                  <div
                    class="coverage-fill"
                    id="coverageFillMain"
                    style="width: 0%"
                  ></div>
                </div>
                <div
                  style="
                    font-size: 9px;
                    color: var(--text-secondary);
                    text-transform: uppercase;
                    letter-spacing: 0.6px;
                    line-height: 1.5;
                  "
                >
                  Target: 105% Min ‚Ä¢ Status:
                  <span
                    id="coverageStatus"
                    style="font-weight: 700; color: var(--text-primary)"
                    >-</span
                  >
                </div>
              </div>

              <div class="data-row" style="flex-shrink: 0">
                <div class="data-label">Excess Collateral</div>
                <div
                  class="data-value"
                  id="excessCollateral"
                  style="font-size: 18px"
                >
                  -
                </div>
                <div class="data-subtitle">Safety Buffer</div>
              </div>

              <div class="timestamp" id="collateralTimestamp">-</div>
            </div>
          </div>

          <!-- Action Buttons - Bottom Row (2 Buttons) -->
          <div class="action-buttons">
            <!-- Report Card -->
            <div class="action-card-compact">
              <div class="action-icon-compact">üìä</div>
              <div class="action-content">
                <div class="action-title-compact">Report</div>
                <div class="action-description-compact">
                  Full verification report with analysis
                </div>
              </div>
              <button
                class="action-button-small"
                onclick="generateReport(event)"
              >
                Generate
              </button>
            </div>

            <!-- Evidence Card: Ïπ¥Îìú ÌÅ¥Î¶≠ = Ï¶ùÎπôÌå© Î™®Îã¨, Î≤ÑÌäº ÌÅ¥Î¶≠ = Ï¶ùÎπô Í∞êÏÇ¨ ÌîÑÎ°¨ÌîÑÌä∏ -->
            <div
              class="action-card-compact"
              onclick="openProofPackModal(event)"
            >
              <div class="action-icon-compact">üì¶</div>
              <div class="action-content">
                <div class="action-title-compact">Evidence</div>
                <div class="action-description-compact">
                  Audit package with transaction logs
                </div>
              </div>
              <button
                class="action-button-small"
                onclick="generateEvidencePack(event)"
              >
                Generate
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Resizer -->
      <div class="resizer" id="resizer"></div>

      <!-- Chat Panel -->
      <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
          <h2>üí¨ Claude AI</h2>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <p style="margin-bottom: 16px">
              <strong>K-WON Ïä§ÌÖåÏù¥Î∏îÏΩîÏù∏ Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏä§ÌÖúÏûÖÎãàÎã§.</strong>
            </p>
            <p style="margin-bottom: 8px">
              <strong>ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏:</strong> 5Ï¥àÎßàÎã§ Ïã§ÏãúÍ∞Ñ Í∞±Ïã†
            </p>
            <p style="margin-bottom: 8px"><strong>Ï£ºÏöî Í∏∞Îä•:</strong></p>
            <ul style="margin-top: 8px; margin-bottom: 0">
              <li>Îã¥Î≥¥ ÎπÑÏú® Ïã§ÏãúÍ∞Ñ Í≤ÄÏ¶ù</li>
              <li>Ïò®/Ïò§ÌîÑÏ≤¥Ïù∏ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù</li>
              <li>Ï¢ÖÌï© Î≥¥Í≥†ÏÑú ÏÉùÏÑ±</li>
              <li>Ï¶ùÎπô ÏûêÎ£å Ìå®ÌÇ§ÏßÄ</li>
            </ul>
          </div>
        </div>

        <div class="chat-input-area">
          <div class="quick-actions">
            <button class="quick-action-btn" onclick="quickAsk('Îã¥Î≥¥ Î∂ÑÏÑù')">
              Îã¥Î≥¥ Î∂ÑÏÑù
            </button>
            <button class="quick-action-btn" onclick="quickAsk('Î≥¥Í≥†ÏÑú')">
              Î≥¥Í≥†ÏÑú
            </button>
            <button class="quick-action-btn" onclick="quickAsk('Ï¶ùÎπôÌå©')">
              Ï¶ùÎπôÌå©
            </button>
            <button class="quick-action-btn" onclick="quickAsk('ÏùÄÌñâ Î¶¨Ïä§ÌÅ¨')">
              ÏùÄÌñâ Î¶¨Ïä§ÌÅ¨
            </button>
          </div>
          <div class="chat-input-container">
            <textarea
              class="chat-input"
              id="chatInput"
              placeholder="Enter your question..."
              rows="1"
            ></textarea>
            <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• Role-Based Allocation Modal -->
    <div class="modal-overlay" id="roleAllocationModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">
            <span>üßÆ</span>
            <span>Ïó≠Ìï† Í∏∞Î∞ò ÏòàÏπò ÎπÑÏ§ë Î∂ÑÏÑù</span>
          </div>
          <button class="modal-close" onclick="closeRoleAllocationModal()">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <!-- Ïã§Ìñâ Î≤ÑÌäº -->
          <button
            id="runRoleAllocation"
            class="action-button-small"
            style="margin-bottom: 20px; font-size: 12px; padding: 10px 20px"
          >
            Ïó≠Ìï† Í∏∞Î∞ò ÎπÑÏ§ë Î∂ÑÏÑù Ïã§Ìñâ
          </button>

          <!-- ÌòÑÏû¨ ÏòàÏπò ÌòÑÌô© -->
          <div id="roleCurrentContainer">
            <div class="role-section-title">Current Allocation</div>
            <table class="role-table" id="roleCurrentTable">
              <!-- Filled by JS -->
            </table>
          </div>

          <!-- Î™©Ìëú ÎπÑÏ§ë -->
          <div id="roleTargetContainer" style="margin-top: 20px">
            <div class="role-section-title">Target Allocation (Role-Based)</div>
            <table class="role-table" id="roleTargetTable">
              <!-- Filled by JS -->
            </table>
          </div>

          <!-- Pie Chart -->
          <div id="rolePieContainer">
            <canvas id="rolePieChart"></canvas>
          </div>

          <!-- Ïû¨ÏòàÏπò Ï†úÏïà -->
          <div id="roleRebalanceContainer" class="rebalance-box">
            <div class="role-section-title">Rebalancing Suggestions</div>
            <div id="roleRebalanceList">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• Proof Pack Modal -->
    <div class="modal-overlay" id="proofPackModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">
            <span>üì¶</span>
            <span>Ï¶ùÎπôÌå© Î™©Î°ù</span>
          </div>
          <button class="modal-close" onclick="closeProofPackModal()">√ó</button>
        </div>
        <div class="modal-body">
          <ul class="proof-pack-list" id="proofPackList">
            <!-- Populated dynamically -->
          </ul>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5100/api";
      let autoRefreshInterval;
      let rolePieChart = null;

      // Resizer Í∏∞Îä•
      (function () {
        const resizer = document.getElementById("resizer");
        const chatPanel = document.getElementById("chatPanel");
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        resizer.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = chatPanel.offsetWidth;
          resizer.classList.add("dragging");
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizing) return;
          const deltaX = startX - e.clientX;
          const newWidth = startWidth + deltaX;
          if (newWidth >= 300 && newWidth <= 800) {
            chatPanel.style.width = newWidth + "px";
          }
        });

        document.addEventListener("mouseup", () => {
          if (isResizing) {
            isResizing = false;
            resizer.classList.remove("dragging");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
          }
        });
      })();

      // Initialize
      window.addEventListener("load", () => {
        checkBackendHealth();
        startAutoRefresh();
      });

      function startAutoRefresh() {
        fullVerification();
        autoRefreshInterval = setInterval(() => {
          fullVerification();
        }, 5000);
      }

      async function checkBackendHealth() {
        try {
          const response = await fetch(`${API_BASE}/health`);
          updateConnectionStatus(true);
        } catch (error) {
          updateConnectionStatus(false);
        }
      }

      function updateConnectionStatus(isOnline) {
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        if (isOnline) {
          statusDot.style.background = "var(--success)";
          statusText.textContent = "Online";
        } else {
          statusDot.style.background = "var(--danger)";
          statusText.textContent = "Offline";
        }
      }

      function formatNumber(num) {
        return new Intl.NumberFormat("ko-KR").format(num);
      }

      function formatKRW(num) {
        return "‚Ç©" + formatNumber(num);
      }

      async function fullVerification() {
        try {
          const response = await fetch(`${API_BASE}/full-verification`);
          const result = await response.json();
          if (result.success) {
            updateMetrics(result.data);
          }
        } catch (error) {
          console.error("API Error:", error);
        }
      }

      function updateMetrics(data) {
        const ratio = data.coverage.coverage_ratio;

        // OnChain
        document.getElementById("totalSupplyMain").textContent = formatKRW(
          data.onchain.total_supply
        );
        document.getElementById("netCirculationMain").textContent = formatKRW(
          data.onchain.net_circulation
        );
        document.getElementById("burnedMain").textContent = formatKRW(
          data.onchain.burned
        );
        document.getElementById("onchainTimestamp").textContent = new Date(
          data.onchain.timestamp
        ).toLocaleString("ko-KR");

        // Coverage Ratio
        document.getElementById("coverageRatioMain").textContent = ratio;
        const ratioElement = document.getElementById("coverageRatioMain");
        ratioElement.className =
          "card-value " +
          (ratio >= 105
            ? "value-ok"
            : ratio >= 100
            ? "value-warning"
            : "value-danger");
        document.getElementById("coverageFillMain").style.width =
          Math.min(ratio, 150) + "%";
        const status =
          ratio >= 105 ? "Healthy" : ratio >= 100 ? "Warning" : "Deficit";
        document.getElementById("coverageStatus").textContent = status;
        const excess =
          data.offchain.total_reserves - data.onchain.net_circulation;
        document.getElementById("excessCollateral").textContent =
          formatKRW(excess);
        document.getElementById("collateralTimestamp").textContent = new Date(
          data.coverage.timestamp
        ).toLocaleString("ko-KR");

        // OffChain
        document.getElementById("totalReservesMain").textContent = formatKRW(
          data.offchain.total_reserves
        );
        const list = document.getElementById("custodianList");
        list.innerHTML = data.offchain.custodians
          .map(
            (c) => `
          <li class="custodian-item">
            <span class="custodian-name">${c.name}</span>
            <span class="custodian-amount">${formatKRW(c.amount)}</span>
          </li>
        `
          )
          .join("");
        document.getElementById("offchainTimestamp").textContent = new Date(
          data.offchain.timestamp
        ).toLocaleString("ko-KR");
      }

      // ========================================
      // PROOF PACK MODAL FUNCTIONS
      // ========================================

      async function openProofPackModal(event) {
        // üî• Generate Î≤ÑÌäº ÌÅ¥Î¶≠Ïù∏ Í≤ΩÏö∞ ‚Üí Ï¶ùÎπô Í∞êÏÇ¨ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÑÏÜ°
        if (event && event.target.closest(".action-button-small")) {
          event.stopPropagation();
          generateEvidencePack(event);
          return;
        }

        // üî• Ïπ¥Îìú ÌÅ¥Î¶≠ ‚Üí Ï¶ùÎπôÌå© Î™®Îã¨ Ïó¥Í∏∞
        const modal = document.getElementById("proofPackModal");
        const list = document.getElementById("proofPackList");

        list.innerHTML =
          '<li class="empty-state"><div class="loading-spinner"></div><p>Î°úÎî© Ï§ë...</p></li>';
        modal.classList.add("active");

        try {
          const response = await fetch(`http://localhost:5100/proof_packs`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          if (!response.ok) {
            throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
          }

          const data = await response.json();
          const files = data.files || [];

          if (files.length === 0) {
            list.innerHTML = `
              <li class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-title">ÏÉùÏÑ±Îêú Ï¶ùÎπôÌå©Ïù¥ ÏóÜÏäµÎãàÎã§</div>
                <div class="empty-state-description">
                  Ï¶ùÎπôÌå©ÏùÑ ÏÉùÏÑ±ÌïòÎ†§Î©¥ Ï±ÑÌåÖÏ∞ΩÏóêÏÑú 'Ï¶ùÎπôÌå© ÎßåÎì§Ïñ¥Ï§ò' ÎùºÍ≥† ÏöîÏ≤≠ÌïòÏÑ∏Ïöî.
                </div>
              </li>
            `;
            return;
          }

          list.innerHTML = files
            .map((file) => {
              const downloadUrl = `http://localhost:5100/proof_packs/${encodeURIComponent(
                file
              )}`;
              const fileSize = "~2.5 KB";
              return `
              <li class="proof-pack-item">
                <div class="proof-pack-info">
                  <div class="proof-pack-name">${file}</div>
                  <div class="proof-pack-meta">ZIP ÌååÏùº ‚Ä¢ ${fileSize}</div>
                </div>
                <a href="${downloadUrl}" class="proof-pack-download" download>Îã§Ïö¥Î°úÎìú</a>
              </li>
            `;
            })
            .join("");
        } catch (error) {
          console.error("Proof pack Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:", error);
          list.innerHTML = `
            <li class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <div class="empty-state-title">Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>
              <div class="empty-state-description">ÏÑúÎ≤Ñ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.<br>${error.message}</div>
            </li>
          `;
        }
      }

      function closeProofPackModal() {
        document.getElementById("proofPackModal").classList.remove("active");
      }

      // ========================================
      // ROLE ALLOCATION MODAL FUNCTIONS
      // ========================================

      function openRoleAllocationModal() {
        document.getElementById("roleAllocationModal").classList.add("active");
      }

      function closeRoleAllocationModal() {
        document
          .getElementById("roleAllocationModal")
          .classList.remove("active");
      }

      // Modal Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
      document
        .getElementById("proofPackModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeProofPackModal();
        });

      document
        .getElementById("roleAllocationModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeRoleAllocationModal();
        });

      // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeProofPackModal();
          closeRoleAllocationModal();
        }
      });

      // Action handlers
      function generateReport(event) {
        if (event) event.stopPropagation();
        addMessage(
          "üìä Generating comprehensive verification report...",
          "assistant"
        );
        setTimeout(() => {
          addMessage(
            "‚úÖ Report Generated!\n\n" +
              "Contents:\n" +
              "‚Ä¢ Collateral ratio analysis\n" +
              "‚Ä¢ On-chain supply verification\n" +
              "‚Ä¢ Off-chain reserve status\n" +
              "‚Ä¢ Risk assessment\n" +
              "‚Ä¢ Time-series data",
            "assistant"
          );
        }, 1500);
      }

      // üî• Generate Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ï¶ùÎπô Í∞êÏÇ¨ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÑÏÜ°
      function generateEvidencePack(event) {
        if (event) {
          event.stopPropagation(); // Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∞®Îã®
        }

        const evidencePrompt = `
ÏßÄÍ∏àÎ∂ÄÌÑ∞ ÎÑàÎäî "Ï¶ùÎπô Î™®Îìú"Î°ú ÎèÑÏôÄÏ£ºÎäî Ïò®Ï≤¥Ïù∏ Í∞êÏÇ¨ Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏Ïïº.

[Í±∞Îûò ÏÑ†ÌÉù Í∑úÏπô]

- ÏÇ¨Ïö©ÏûêÍ∞Ä Í±∞Îûò Ìï¥Ïãú(tx_hash)Î•º Ï£ºÎ©¥:
  ‚Üí events_search(tx_hash=..., tx_prefix_ok=true, limit=1) Ìà¥Î°ú Ìï¥Îãπ Í±∞Îûò 1Í±¥ÏùÑ Ï∞æÍ≥†,
     Í∑∏ Ïù¥Î≤§Ìä∏Ïùò tx_hashÎ•º Ï¶ùÎπô ÎåÄÏÉÅ Í±∞ÎûòÎ°ú ÏÇ¨Ïö©Ìï¥.

- From / To Ï£ºÏÜåÎ°ú ÏöîÏ≤≠ÌïòÎ©¥:
  ‚Üí Î¨∏Îß•ÏùÑ Î≥¥Í≥† roleÏùÑ Ï†ïÌï¥:
     ‚Ä¢ "Î≥¥ÎÇ∏/Ï∂úÍ∏à" ÎäêÎÇå ‚Üí role="from"
     ‚Ä¢ "Î∞õÏùÄ/ÏûÖÍ∏à" ÎäêÎÇå ‚Üí role="to"
     ‚Ä¢ Í∑∏ÎÉ• "Í¥ÄÎ†® Í±∞Îûò" ‚Üí role="any"
  ‚Üí events_search(address=..., role=..., limit=20)ÏùÑ Ìò∏Ï∂úÌïòÍ≥†,
     "Í∞ÄÏû• ÏµúÍ∑º", "nÎ≤àÏß∏" Í∞ôÏùÄ ÏÇ¨Ïö©ÏûêÏùò ÏöîÏ≤≠Ïóê ÎßûÎäî Í±∞Îûò 1Í±¥ÏùÑ ÏÑ†ÌÉùÌï¥ÏÑú
     Í∑∏ tx_hashÎ•º Ï¶ùÎπô ÎåÄÏÉÅÏúºÎ°ú ÏÇ¨Ïö©Ìï¥.

- ÏãúÍ∞Ñ Ï°∞Í±¥(Ïòà: "Ïñ¥Ï†ú Ïù¥ÌõÑ", "ÏµúÍ∑º 1ÏãúÍ∞Ñ")ÏúºÎ°ú ÏöîÏ≤≠ÌïòÎ©¥:
  ‚Üí ÏûêÏó∞Ïñ¥Î•º start_iso / end_isoÎ°ú Ï†ÅÎãπÌûà Ìï¥ÏÑùÌï¥ÏÑú
     events_search(start_iso=..., end_iso=..., limit=20)ÏúºÎ°ú Í±∞ÎûòÎ•º Ï∞æÍ≥†,
     Í∑∏ Ï§ëÏóêÏÑú ÏöîÏ≤≠Ïóê ÎßûÎäî Í±∞Îûò 1Í±¥Ïùò tx_hashÎ•º Ï¶ùÎπô ÎåÄÏÉÅÏúºÎ°ú ÏÇ¨Ïö©Ìï¥.

- ÏúÑ ÏÑ∏ Í∞ÄÏßÄ Ï°∞Í±¥Ïù¥ Ï†ÑÌòÄ ÏóÜÍ≥†, Í∑∏ÎÉ• "Ï¶ùÎπôÌå© ÎßåÎì§Ïñ¥Ï§ò" Ï†ïÎèÑÎßå ÏûàÏúºÎ©¥:
  ‚Üí events_recent(limit=1, tz="UTC", include_raw=true)ÏúºÎ°ú
     Í∞ÄÏû• ÏµúÍ∑º Í±∞Îûò 1Í±¥ÏùÑ ÏÑ†ÌÉùÌï¥ÏÑú Í∑∏ tx_hashÎ•º ÏÇ¨Ïö©Ìï¥.

[Î®∏ÌÅ¥ Î∞∞Ïπò / ÏïµÏª§ÎßÅ ÌôïÏù∏]

ÏÑ†ÌÉùÎêú tx_hashÎ°ú Î®ºÏ†Ä event_proof(tx_hash=..., tz="UTC")Î•º Ìò∏Ï∂úÌï¥ÏÑú ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥ Ï§ò.

- Ïù¥Î≤§Ìä∏Î•º Ï∞æÏßÄ Î™ªÌïú Í≤ΩÏö∞(null Ïù¥Í±∞ÎÇò "event not found" ÎäêÎÇå):
  ‚Üí "ÏïÑÏßÅ DBÏóê Ïù¥ Í±∞ÎûòÍ∞Ä ÏàòÏßëÎêòÏßÄ ÏïäÏùÄ Í≤É Í∞ôÏäµÎãàÎã§. ÌïÑÏöîÌïòÎã§Î©¥ Ïò®Ï≤¥Ïù∏ Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßë(collect_once)Ìï¥ÏÑú Îã§Ïãú ÏãúÎèÑÌï† Ïàò ÏûàÏäµÎãàÎã§." ÎùºÍ≥† ÏÑ§Î™ÖÌï¥.
  ‚Üí collect_onceÎäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏõêÌïúÎã§Í≥† ÌñàÏùÑ ÎïåÎßå Ìò∏Ï∂úÌï¥.

- batch_idÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞(Ïñ¥Îñ§ Î∞∞ÏπòÏóêÎèÑ Ïïà Îì§Ïñ¥Í∞Ñ Í±∞Îûò):
  ‚Üí Î®ºÏ†Ä ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î¨ºÏñ¥Î¥ê:
    "Ïù¥ Í±∞ÎûòÎäî ÏïÑÏßÅ Î®∏ÌÅ¥ Î∞∞ÏπòÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.
     ÏßÄÍ∏à Ïù¥ Í±∞ÎûòÎ•º Ìè¨Ìï®Ìïú Î®∏ÌÅ¥ Î∞∞ÏπòÎ•º ÎßåÎì§Í≥†, Ïù¥Ïñ¥ÏÑú ÏïµÏª§ÎßÅÍ≥º Ï¶ùÎπôÌå© ÏÉùÏÑ±ÍπåÏßÄ ÏßÑÌñâÌï†ÍπåÏöî?"
  ‚Üí ÏÇ¨Ïö©ÏûêÍ∞Ä ÎèôÏùòÌïòÎ©¥:
    1) make_batch(limit=1000, mode="oldest") Îì±ÏùÑ Ìò∏Ï∂úÌï¥ÏÑú Î∞∞ÏπòÎ•º ÎßåÎì§Í≥†
    2) Í∞ôÏùÄ tx_hashÎ°ú Îã§Ïãú event_proofÎ•º Ìò∏Ï∂úÌï¥ÏÑú batch_idÏôÄ proofÍ∞Ä ÏÉùÍ≤ºÎäîÏßÄ ÌôïÏù∏Ìïú Îí§
    3) ÏïÑÎûò Ï¶ùÎπôÌå© ÏÉùÏÑ± Îã®Í≥ÑÎ°ú ÏßÑÌñâÌï¥.
  ‚Üí ÎèôÏùòÌïòÏßÄ ÏïäÏúºÎ©¥:
    - Î∞∞Ïπò/ÏïµÏª§ÎßÅÏùÄ Ïã§ÌñâÌïòÏßÄ ÎßêÍ≥†,
    - "ÌòÑÏû¨ Ïù¥ Í±∞ÎûòÎäî ÏïÑÏßÅ Î®∏ÌÅ¥ Î∞∞ÏπòÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú"ÎùºÍ≥†Îßå ÏÑ§Î™ÖÌï¥ Ï§ò.

- batch_idÎäî ÏûàÎäîÎç∞ ÏïÑÏßÅ ÏïµÏª§ÎßÅÏù¥ Ïïà Îêú Í≤ΩÏö∞:
  ‚Üí anchor_status(batch_id=..., chain="mock")Î°ú ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥.
  ‚Üí statusÍ∞Ä "anchored"Í∞Ä ÏïÑÎãàÎùºÎ©¥, ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î¨ºÏñ¥Î¥ê:
    "Ïù¥ Í±∞ÎûòÍ∞Ä Ìè¨Ìï®Îêú Î∞∞Ïπò {batch_id} Îäî ÏïÑÏßÅ ÏïµÏª§ÎßÅÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.
     mock Ï≤¥Ïù∏Ïóê ÏïµÏª§ÎßÅÏùÑ ÏàòÌñâÌïú Îí§, Ï¶ùÎπôÌå©ÍπåÏßÄ ÏÉùÏÑ±Ìï¥ ÎìúÎ¶¥ÍπåÏöî?"
  ‚Üí ÏÇ¨Ïö©ÏûêÍ∞Ä ÎèôÏùòÌïòÎ©¥:
    1) anchor_batch(batch_id=..., chain="mock")Î•º Ìò∏Ï∂úÌïòÍ≥†
    2) ÌïÑÏöîÌïòÎ©¥ anchor_statusÎ°ú anchored ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìïú Îí§
    3) Ï¶ùÎπôÌå© ÏÉùÏÑ± Îã®Í≥ÑÎ°ú ÏßÑÌñâÌï¥.
  ‚Üí ÏÇ¨Ïö©ÏûêÍ∞Ä Í±∞Ï†àÌïòÎ©¥:
    - "ÌòÑÏû¨Îäî Î®∏ÌÅ¥ Î∞∞ÏπòÍπåÏßÄÎßå ÎêòÏñ¥ ÏûàÍ≥† Ïò®Ï≤¥Ïù∏ ÏïµÏª§ÎßÅÏùÄ ÎêòÏñ¥ ÏûàÏßÄ ÏïäÏùÄ ÏÉÅÌÉú"ÎùºÍ≥† Î∂ÑÎ™ÖÌûà ÏïåÎ†§Ï£ºÍ≥†,
    - Í∑∏ ÏÉÅÌÉú Í∑∏ÎåÄÎ°ú Ï¶ùÎπôÌå© ÏÉùÏÑ±ÏùÑ ÏõêÌïòÎ©¥ ÏßÑÌñâÌï¥ÎèÑ Îèº.

- Ïù¥ÎØ∏ Î®∏ÌÅ¥ Î∞∞Ïπò + ÏïµÏª§ÎßÅÍπåÏßÄ ÎÅùÎÇú ÏÉÅÌÉúÎ©¥:
  ‚Üí Î∞îÎ°ú Ï¶ùÎπôÌå© ÏÉùÏÑ± Îã®Í≥ÑÎ°ú ÎÑòÏñ¥Í∞ÄÎ©¥ Îèº.

[Ï¶ùÎπôÌå© ÏÉùÏÑ±]

Ï§ÄÎπÑÍ∞Ä ÎÅùÎÇú tx_hashÏóê ÎåÄÌï¥ proof_pack(
  tx_hash=...,
  include_raw=true,
  tz="UTC",
  as_zip=true
)ÏùÑ Ìò∏Ï∂úÌï¥ÏÑú Ï¶ùÎπôÌå©ÏùÑ ÎßåÎì†Îã§.

proof_pack ÏùëÎãµÏóêÏÑú
- path
- sha256
- bytes
Í∞íÏùÑ Î∞òÎìúÏãú Ïã§Ï†ú Í∑∏ÎåÄÎ°ú Í∫ºÎÇ¥ÏÑú Î≥¥Ïó¨Ï£ºÍ≥†,
"Ïù¥ Í≤ΩÎ°úÏóê ZIP Ï¶ùÎπôÌå©Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§." ÎùºÍ≥† ÏïàÎÇ¥Ìï¥ Ï§ò.

Îòê, Í∞ÄÎä•ÌïòÎ©¥ Ïù¥ Í±∞ÎûòÏóê ÎåÄÌïú ÏöîÏïΩÎèÑ Ìï®Íªò Î≥¥Ïó¨Ï§ò:
- Í∏àÏï°, From / To Ï£ºÏÜå
- Î∏îÎ°ù Î≤àÌò∏
- Í±∞Îûò ÏãúÍ∞Ñ(ÏöîÏ≤≠Ìïú ÏãúÍ∞ÑÎåÄÏóê ÎßûÏ∂∞ Ìè¨Îß∑)
Îì±ÏùÑ Ï†ïÎ¶¨Ìï¥ÏÑú "Ïñ¥Îñ§ Í±∞ÎûòÏóê ÎåÄÌïú Ï¶ùÎπôÌå©Ïù∏ÏßÄ" Ìïú ÎààÏóê Ïïå Ïàò ÏûàÍ≤å ÏÑ§Î™ÖÌï¥.

[Îã§Ïãú ÏöîÏ≤≠ÌïòÎäî Í≤ΩÏö∞]

ÏÇ¨Ïö©ÏûêÍ∞Ä "Îã§Î•∏ Í±∞ÎûòÎ°ú Ï¶ùÎπôÌå© ÎßåÎì§Ïñ¥Ï§ò", "Ïù¥Î≤àÏóî Ï†Ä Í±∞ÎûòÎ°ú" Îì±ÏúºÎ°ú Îã§Ïãú ÏöîÏ≤≠ÌïòÎ©¥,
- ÏÉà Í∏∞Ï§ÄÏóê ÎßûÏ∂∞ events_search / events_recentÎ°ú Í±∞ÎûòÎ•º Îã§Ïãú Í≥†Î•¥Í≥†
- ÏúÑÏôÄ Í∞ôÏùÄ ÏàúÏÑú(Î®∏ÌÅ¥ Î∞∞Ïπò/ÏïµÏª§ÎßÅ ÌôïÏù∏ ‚Üí ÌïÑÏöîÏãú ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î¨ºÏñ¥Î≥¥Í∏∞ ‚Üí proof_pack ÏÉùÏÑ±)Î°ú Îã§Ïãú ÏßÑÌñâÌï¥.

Ï§ëÏöî:
- Ìà¥ÏùÑ Ïã§Ï†úÎ°ú Ìò∏Ï∂úÌïòÏßÄ ÏïäÍ≥† Í≤∞Í≥ºÎ•º ÏÉÅÏÉÅÌï¥ÏÑú ÎßåÎì§Ïñ¥ÎÇ¥ÏßÄ Îßà.
- Ìï≠ÏÉÅ events_search / events_recent / event_proof / make_batch /
  anchor_status / anchor_batch / proof_pack Ïùò Ïã§Ï†ú ÏùëÎãµÏùÑ Í∏∞Î∞òÏúºÎ°ú ÏÑ§Î™ÖÌï¥.
        `.trim();

        sendMessageWith(evidencePrompt, "üì¶ Ï¶ùÎπôÌå© ÏÉùÏÑ± Î™®ÎìúÎ°ú Ï†ÑÌôòÌï©ÎãàÎã§...");
      }

      // Chat functions
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const loadingDotsHTML =
        '<span class="loading-dots"><span></span><span></span><span></span></span>';

      chatInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      chatInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function quickAsk(question) {
        chatInput.value = question;
        sendMessage();
      }

      function addMessage(text, type) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        if (type === "assistant") {
          try {
            const htmlContent = marked.parse(text);
            messageDiv.innerHTML = htmlContent;
          } catch (error) {
            console.error("Markdown parsing error:", error);
            messageDiv.innerHTML = text.replace(/\n/g, "<br>");
          }
        } else {
          messageDiv.innerHTML = text.replace(/\n/g, "<br>");
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessageWith(text, displayText = null) {
        const message = text.trim();
        if (!message) return;

        addMessage(displayText || message, "user");
        chatInput.value = "";
        chatInput.style.height = "auto";

        const sendBtn = document.getElementById("sendBtn");
        sendBtn.disabled = true;

        const assistantMessageDiv = document.createElement("div");
        assistantMessageDiv.className = "message assistant typing";
        assistantMessageDiv.innerHTML = loadingDotsHTML;
        chatMessages.appendChild(assistantMessageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch(`${API_BASE}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });

          if (!response.ok) {
            throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
          }

          const data = await response.json();
          const fullText =
            data.response ||
            data.error ||
            "‚ö†Ô∏è ÏÑúÎ≤ÑÏóêÏÑú ÏùëÎãµÏùÑ Î∞õÏïòÏßÄÎßå ÎÇ¥Ïö©ÏùÑ Ìï¥ÏÑùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.";

          assistantMessageDiv.classList.remove("typing");
          const htmlContent = marked.parse(fullText);
          assistantMessageDiv.innerHTML = htmlContent;
        } catch (error) {
          console.error("Chat API Error:", error);
          assistantMessageDiv.classList.remove("typing");
          assistantMessageDiv.innerHTML =
            "‚ö†Ô∏è ÏÑúÎ≤ÑÏôÄ Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Flask ÏÑúÎ≤Ñ ÎòêÎäî MCP ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.";
        }

        sendBtn.disabled = false;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        await sendMessageWith(message);
      }

      // ========================================
      // ROLE-BASED RESERVE ALLOCATION ENGINE
      // ========================================

      async function loadCurrentExposures() {
        try {
          const res = await fetch(`${API_BASE}/full-reserves`);
          return await res.json();
        } catch (e) {
          console.error("Error loading reserves", e);
          return [];
        }
      }

      async function callMCP(functionName, args) {
        try {
          const res = await fetch(`${API_BASE}/mcp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              function: functionName,
              arguments: args,
            }),
          });
          return await res.json();
        } catch (e) {
          console.error("MCP Error:", e);
          return { error: "MCP call failed" };
        }
      }

      function renderRoleTable(tableElem, rows, columns) {
        let html = `<thead><tr>${columns
          .map((c) => `<th>${c.header}</th>`)
          .join("")}</tr></thead><tbody>`;
        rows.forEach((row) => {
          html += `<tr>`;
          columns.forEach((col) => {
            html += `<td>${row[col.key]}</td>`;
          });
          html += `</tr>`;
        });
        html += `</tbody>`;
        tableElem.innerHTML = html;
      }

      function renderRolePieChart(targets) {
        const ctx = document.getElementById("rolePieChart");
        if (rolePieChart) {
          rolePieChart.destroy();
        }
        rolePieChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: targets.map(
              (t) => `${t.name} (${(t.target_pct * 100).toFixed(1)}%)`
            ),
            datasets: [
              {
                data: targets.map((t) => t.target_pct * 100),
                backgroundColor: [
                  "#ff6b35",
                  "#ff8c42",
                  "#00e676",
                  "#ffa502",
                  "#1e90ff",
                  "#2ed573",
                  "#5352ed",
                  "#ff4757",
                ],
              },
            ],
          },
        });
      }

      function renderRebalancePlan(list) {
        const container = document.getElementById("roleRebalanceList");
        if (!list || list.length === 0) {
          container.innerHTML = `<div style="color:var(--text-secondary); font-size:12px;">Î™®Îì† ÎπÑÏ§ëÏù¥ Ïó≠Ìï† Í∏∞Ï§ÄÏóê Ï†ÅÌï©Ìï©ÎãàÎã§. Ïû¨Î∞∞Î∂Ñ ÌïÑÏöî ÏóÜÏùå.</div>`;
          return;
        }
        let html = "";
        list.forEach((item) => {
          html += `
            <div class="rebalance-item">
              <strong>${item.from_bank}</strong> ‚Üí <strong>${
            item.to_bank
          }</strong><br>
              Ïù¥Îèô Í∏àÏï°: <strong>${formatKRW(item.amount)}</strong><br>
              <em>${item.reason}</em>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      document
        .getElementById("runRoleAllocation")
        .addEventListener("click", async () => {
          addMessage(
            "üßÆ Ïó≠Ìï† Í∏∞Î∞ò ÏòàÏπò ÎπÑÏ§ë Î∂ÑÏÑùÏùÑ ÏãúÏûëÌï©ÎãàÎã§...",
            "assistant"
          );

          const institutions = await loadCurrentExposures();

          renderRoleTable(
            document.getElementById("roleCurrentTable"),
            institutions,
            [
              { key: "bank_id", header: "Bank ID" },
              { key: "name", header: "Name" },
              { key: "exposure", header: "Exposure" },
              { key: "fss", header: "FSS Score" },
              { key: "role", header: "Role" },
            ]
          );

          const alloc = await callMCP("role_based_allocation", {
            institutions: institutions,
          });

          if (alloc.error || !alloc.result || !alloc.result.banks) {
            addMessage("‚ö†Ô∏è MCP Ïò§Î•ò: Ïó≠Ìï† Í∏∞Î∞ò Î∞∞Î∂Ñ Í≥ÑÏÇ∞ Ïã§Ìå®", "assistant");
            return;
          }

          renderRoleTable(
            document.getElementById("roleTargetTable"),
            alloc.result.banks,
            [
              { key: "bank_id", header: "Bank ID" },
              { key: "name", header: "Bank Name" },
              { key: "role", header: "Role" },
              { key: "target_pct", header: "Target %" },
              { key: "target_amount", header: "Target Amount" },
            ]
          );

          renderRolePieChart(alloc.result.banks);

          const reb = await callMCP("role_based_rebalance", {
            institutions: institutions,
          });

          if (reb.error) {
            addMessage("‚ö†Ô∏è MCP Ïò§Î•ò: Ïû¨ÏòàÏπò ÌîåÎûú Í≥ÑÏÇ∞ Ïã§Ìå®", "assistant");
          } else {
            renderRebalancePlan(reb.result.rebalance_plan || []);
            addMessage(
              "üìà Ïó≠Ìï† Í∏∞Î∞ò Î∂ÑÏÑù Î∞è Ïû¨ÏòàÏπò Ï†úÏïàÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.",
              "assistant"
            );
          }
        });
    </script>
  </body>
</html>
