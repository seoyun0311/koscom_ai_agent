# docker-compose.yml

# 외부 Ncloud PostgreSQL 연결 하드코딩 (모든 서비스에서 공유)
x-db-env: &db-env
  PG_HOST: "host.docker.internal"
  PG_PORT: "5432"
  PG_USER: "dancom"
  PG_PASSWORD: "1q2w3e4r!"
  PG_DB: "dancom_db"
  DATABASE_URL: "postgresql+asyncpg://dancom:1q2w3e4r!@host.docker.internal:5432/dancom_db"


services:

  # ===========================================================
  # 1) 웹 프론트엔드
  # ===========================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_web
    command: ["python", "frontend/web_chat_app.py"]
    ports:
      - "5100:5100"
    env_file:
      - .env
    environment:
      BANK_MONITORING_MCP: http://bank-monitoring:5300/mcp
      KRW_RESERVE_MCP: http://krw-reserve:5400/mcp
      # ⚠ 로컬 .env에서 사용하던 키 이름과 반드시 일치시켜야 함
      TX_AUDIT_MCP: http://tx-audit:5200/mcp
      K_WON_MCP_URL: http://kwon-reports-gateway:5900/mcp
      BACKEND_URL: ${BACKEND_BASE_URL:-http://175.45.205.39:4000}
    volumes:
      - tx-audit-data:/app/mcp_servers/tx_audit/data
    depends_on:
      - bank-monitoring
      - krw-reserve
      - tx-audit
      - kwon-reports-gateway

  # ===========================================================
  # 2) Bank Monitoring MCP
  # ===========================================================
  bank-monitoring:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_bank_monitoring
    command: ["python", "mcp_servers/bank_monitering/mcp_http_gateway.py"]
    environment:
      <<: *db-env
    depends_on:
      - influxdb

  # ===========================================================
  # 3) KRW Full Reserve MCP
  # ===========================================================
  krw-reserve:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_krw_reserve
    command: ["python", "mcp_servers/krw-full-reserve/mcp_http_gateway.py"]
    environment:
      <<: *db-env
    depends_on:
      - influxdb

  # ===========================================================
  # 4) TX Audit MCP Gateway
  # ===========================================================
  tx-audit:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_tx_audit
    command: ["python", "mcp_servers/tx_audit/audit_gateway.py"]
    env_file:
      - .env
      - ./mcp_servers/tx_audit/.env
    environment:
      <<: *db-env
    depends_on:
      - influxdb
    volumes:
      - tx-audit-data:/app/mcp_servers/tx_audit/data

  # ===========================================================
  # 4-1) Collector
  # ===========================================================
  tx-audit-collector:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_tx_audit_collector
    working_dir: /app/mcp_servers/tx_audit
    command: ["python", "-m", "apps.api.collector"]
    env_file:
      - .env
      - ./mcp_servers/tx_audit/.env
    environment:
      <<: *db-env
    volumes:
      - tx-audit-data:/app/mcp_servers/tx_audit/data

  # ===========================================================
  # 4-2) Merkle Worker
  # ===========================================================
  tx-audit-merkle:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_tx_audit_merkle
    working_dir: /app/mcp_servers/tx_audit
    command: ["python", "-m", "apps.api.merkle"]
    env_file:
      - .env
      - ./mcp_servers/tx_audit/.env
    environment:
      <<: *db-env
    depends_on:
      - tx-audit
    volumes:
      - tx-audit-data:/app/mcp_servers/tx_audit/data

  # ===========================================================
  # 5) Reports Backend (FastAPI)
  # ===========================================================
  kwon-reports-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_kwon_reports_backend
    command: ["python", "mcp_servers/report-master/mcp_server.py"]
    env_file:
      - .env
      - ./mcp_servers/report-master/.env
    environment:
      APP_HOST: 0.0.0.0
      APP_PORT: 8000
      <<: *db-env
    ports:
      - "8000:8000"
    volumes:
      - ./mcp_servers/report-master/artifacts:/app/mcp_servers/report-master/artifacts

  # ===========================================================
  # 6) Reports Gateway
  # ===========================================================
  kwon-reports-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: koscom_kwon_reports_gateway
    command: ["python", "mcp_servers/report-master/gateway.py"]
    env_file:
      - .env
      - ./mcp_servers/report-master/.env
    environment:
      MCP_BACKEND_BASE: http://kwon-reports-backend:8000
    ports:
      - "5900:5900"
    depends_on:
      - kwon-reports-backend

  # ===========================================================
  # 7) InfluxDB
  # ===========================================================
  influxdb:
    image: influxdb:latest
    container_name: influxdb
    expose:
      - "8086"
    volumes:
      - influxdb2-data:/var/lib/influxdb2
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: StrongP@ssw0rd
      DOCKER_INFLUXDB_INIT_ORG: dancom
      DOCKER_INFLUXDB_INIT_BUCKET: my-bucket
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: SOME_LONG_RANDOM_TOKEN

  # ===========================================================
  # 8) InfluxDB Proxy
  # ===========================================================
  influx-proxy:
    image: nginx:latest
    container_name: influx-proxy
    ports:
      - "8086:80"
    volumes:
      - ./infra/docker/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - influxdb

# ===========================================================
# VOLUMES
# ===========================================================
volumes:
  influxdb2-data:
  tx-audit-data:
